<!DOCTYPE html>
<html>
<head>
    <title>PortfolioItem-DeepTag</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"choosers",flex:1,layout:"hbox",padding:10},{xtype:"container",itemId:"buttons",flex:1,layout:"hbox"},{xtype:"container",itemId:"status",flex:1}],_tagPicker:null,_featurePicker:null,_proceedDialog:null,_noFeatureDialog:null,_typeFeature:"/PortfolioItem/Feature",_selectedFeatures:[],_selectedTags:[],_selectedTagNames:[],_selectedTagsByName:{},_nullOutTagsFlag:!1,_statusContent:null,_hydratedFeatures:[],_storiesCollectionOids:[],_hydratedStories:[],_storyTasksCollectionOids:[],_hydratedStoryTasks:[],_storyDefectsCollectionOids:[],_hydratedStoryDefects:[],_defectTasksCollectionOids:[],_hydratedDefectTasks:[],_hydratedArtifactsByOid:{},_artifactTagsByOid:{},launch:function(){this._getPITypes()},_buildUI:function(){var me=this;this._featurePicker=Ext.create("Rally.ui.picker.MultiObjectPicker",{fieldLabel:"Choose a Feature",modelType:this._typeFeature}),this.down("#choosers").add(this._featurePicker),this._tagPicker=Ext.create("Rally.ui.picker.TagPicker",{fieldLabel:"Select Tags",autoExpand:!1,listeners:{click:function(){me._getSelectedTags()}}}),this.down("#choosers").add(this._tagPicker),this.down("#buttons").add({xtype:"rallybutton",text:"Apply Tags to Feature Hierarchy",handler:function(){me._confirmAction()}})},_getPITypes:function(){var me=this,piDataStore=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",autoLoad:!0,fetch:!0,listeners:{scope:this,load:me._PITypeStoreLoaded},filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"Ordinal",operator:"=",value:0}]})},_PITypeStoreLoaded:function(store,records){this._typeFeature=records[0].get("TypePath").toLowerCase(),this._buildUI()},_getSelectedFeatures:function(){this._selectedFeatures=this._featurePicker._getRecordValue()},_getSelectedTags:function(){var me=this;me._selectedTags=me._tagPicker._getRecordValue(),Ext.Array.each(me._selectedTags,function(tag){var tagName=tag.get("Name");me._selectedTagsByName[tagName]=tag,me._selectedTagNames.push(tagName)})},_confirmAction:function(){var me=this;if(me._getSelectedFeatures(),me._getSelectedTags(),0===me._selectedFeatures.length)return me._noSelectionsNotify(),void 0;0===me._selectedTags.length&&(me._nullOutTagsFlag=!0);var message="This will _add_ selected Tags to all Artifacts (Stories, Defects, Tasks) Under chosen Features. Proceed?",confirmLabel="Bulk Tag Hierarchy";me._nullOutTagsFlag&&(message="This will _remove_ all Tags from all Artifacts (Stories, Defects, Tasks) Under chosen Features. Proceed?",confirmLabel="Clear _all_ Tags from Hierarchy"),me._proceedDialog&&me._proceedDialog.destroy(),Ext.create("Rally.ui.dialog.ConfirmDialog",{message:message,confirmLabel:confirmLabel,listeners:{confirm:function(){me._nullOutExistingData(),me._hydrateData()}}})},_nullOutExistingData:function(){var me=this;me._hydratedFeatures=[],me._storiesCollectionOids=[],me._hydratedStories=[],me._storyTasksCollectionOids=[],me._hydratedStoryTasks=[],me._storyDefectsCollectionOids=[],me._hydratedStoryDefects=[],me._defectTasksCollectionOids=[],me._hydratedDefectTasks=[],me._hydratedArtifactsByOid={},me._artifactTagsByOid={}},_nullOutSelectionData:function(){var me=this;me._selectedFeatures=[],me._selectedTags=[],me._selectedTagNames=[],me._selectedTagsByName={},me._nullOutTagsFlag=!1,me._statusContent=null},_hydrateData:function(){var me=this,hydrateFeaturesPromise=function(){return me._hydrateFeatures(me)},getStoriesCollectionPromise=function(){return me._getStoriesCollection(me)},hydrateStoriesPromise=function(){return me._hydrateStories(me)},getStoryTasksCollectionPromise=function(){return me._getStoryTaskCollections(me)},hydrateStoryTasksPromise=function(){return me._hydrateStoryTasks(me)},getStoryDefectsCollectionPromise=function(){return me._getStoryDefectsCollection(me)},hydrateStoryDefectsPromise=function(){return me._hydrateStoryDefects(me)},getDefectTasksCollectionPromise=function(){return me._getDefectTaskCollections(me)},hydrateDefectTasksPromise=function(){return me._hydrateDefectTasks(me)},combineHydratedArtifactsPromise=function(){return me._combineHydratedArtifacts(me)},hydrateAllArtifactTagsPromise=function(){return me._hydrateAllArtifactTags(me)},tagAllArtifactsPromise=function(){return me._tagAllArtifacts(me)},finishedNotifyPromise=function(){return me._finishedNotify(me)},promises=[hydrateFeaturesPromise,getStoriesCollectionPromise,hydrateStoriesPromise,getStoryTasksCollectionPromise,hydrateStoryTasksPromise,getStoryDefectsCollectionPromise,hydrateStoryDefectsPromise,getDefectTasksCollectionPromise,hydrateDefectTasksPromise,combineHydratedArtifactsPromise,hydrateAllArtifactTagsPromise,tagAllArtifactsPromise,finishedNotifyPromise];Deft.Chain.sequence(promises).then({scope:this,success:function(records){},failure:function(error){deferred.reject("Problem resolving chain "+error)}})},_hydrateFeatures:function(scope){var me=scope;me.setLoading("Loading Features.");var promises=[],deferred=Ext.create("Deft.Deferred");return Ext.Array.each(me._selectedFeatures,function(feature){promises.push(me._hydrateArtifact(feature.get("ObjectID"),me._typeFeature,me))}),Deft.Promise.all(promises).then({success:function(results){me._hydratedFeatures=results,deferred.resolve(results)}}),deferred},_hydrateStories:function(scope){var me=scope;me.setLoading("Loading Stories");var promises=[],deferred=Ext.create("Deft.Deferred");return me._storiesCollectionOids.length>0?(Ext.Array.each(me._storiesCollectionOids,function(storyOid){promises.push(me._hydrateArtifact(storyOid,"HierarchicalRequirement",me))}),Deft.Promise.all(promises).then({success:function(results){me._hydratedStories=results,deferred.resolve([])}})):deferred.resolve([]),deferred},_hydrateStoryTasks:function(scope){var me=scope;me.setLoading("Loading Tasks of Stories.");var promises=[],deferred=Ext.create("Deft.Deferred");return me._storyTasksCollectionOids.length>0?(Ext.Array.each(me._storyTasksCollectionOids,function(taskOid){promises.push(me._hydrateArtifact(taskOid,"Task",me))}),Deft.Promise.all(promises).then({success:function(results){me._hydratedStoryTasks=results,deferred.resolve([])}})):deferred.resolve([]),deferred},_getStoriesCollection:function(scope){var me=scope,promises=[],deferred=Ext.create("Deft.Deferred");return Ext.Array.each(me._hydratedFeatures,function(feature){promises.push(me._hydrateArtifactCollection(feature,"UserStories",me,me._storiesCollectionOids))}),Deft.Promise.all(promises).then({success:function(results){deferred.resolve(results)}}),deferred},_getStoryTaskCollections:function(scope){var me=scope,promises=[],deferred=Ext.create("Deft.Deferred");return me._hydratedStories.length>0?(Ext.Array.each(me._hydratedStories,function(story){promises.push(me._hydrateArtifactCollection(story,"Tasks",me,me._storyTasksCollectionOids))}),Deft.Promise.all(promises).then({success:function(results){deferred.resolve([])}})):deferred.resolve([]),deferred},_getStoryDefectsCollection:function(scope){var me=scope,promises=[],deferred=Ext.create("Deft.Deferred");return me._hydratedStories.length>0?(Ext.Array.each(me._hydratedStories,function(story){promises.push(me._hydrateArtifactCollection(story,"Defects",me,me._storyDefectsCollectionOids))}),Deft.Promise.all(promises).then({success:function(results){deferred.resolve([])}})):deferred.resolve([]),deferred},_hydrateStoryDefects:function(scope){var me=scope;me.setLoading("Loading Defects of Stories.");var promises=[],deferred=Ext.create("Deft.Deferred");return me._storyDefectsCollectionOids.length>0?(Ext.Array.each(me._storyDefectsCollectionOids,function(defectOid){promises.push(me._hydrateArtifact(defectOid,"Defect",me))}),Deft.Promise.all(promises).then({success:function(results){me._hydratedStoryDefects=results,deferred.resolve([])}})):deferred.resolve([]),deferred},_getDefectTaskCollections:function(scope){var me=scope,promises=[],deferred=Ext.create("Deft.Deferred");return me._hydratedStoryDefects.length>0?(Ext.Array.each(me._hydratedStoryDefects,function(defect){promises.push(me._hydrateArtifactCollection(defect,"Tasks",me,me._defectTasksCollectionOids))}),Deft.Promise.all(promises).then({success:function(results){deferred.resolve([])}})):deferred.resolve([]),deferred},_hydrateDefectTasks:function(scope){var me=scope;me.setLoading("Loading Tasks of Defects");var promises=[],deferred=Ext.create("Deft.Deferred");return me._defectTasksCollectionOids.length>0?(Ext.Array.each(me._defectTasksCollectionOids,function(taskOid){promises.push(me._hydrateArtifact(taskOid,"Task",me))}),Deft.Promise.all(promises).then({success:function(results){me._hydratedDefectTasks=results,deferred.resolve([])}})):deferred.resolve([]),deferred},_hydrateArtifactCollection:function(artifact,collectionName,scope,oidsArray){var deferred=Ext.create("Deft.Deferred"),me=scope,artifactRef=artifact.get("_ref"),artifactObjectID=artifact.get("ObjectID"),artifactFormattedID=artifact.get("FormattedID"),artifactName=artifact.get("Name"),artifactCollection=artifact.getCollection(collectionName,{fetch:["Name","FormattedID","ObjectID","Tags"]}),collectionCount=artifactCollection.getCount();return artifactCollection.load({callback:function(records,operation,success){Ext.Array.each(records,function(record){oidsArray.push(record.get("ObjectID"))}),deferred.resolve([])}}),deferred},_hydrateArtifact:function(artifactOid,type,scope){var deferred=Ext.create("Deft.Deferred"),me=scope,featureModel=Rally.data.ModelFactory.getModel({type:type,scope:this,success:function(model,operation){model.load(artifactOid,{scope:this,success:function(record,operation){deferred.resolve(record)}})}});return deferred},_combineHydratedArtifacts:function(scope){var me=scope;Ext.Array.each(me._hydratedFeatures,function(feature){var oid=feature.get("ObjectID");me._hydratedArtifactsByOid[oid]=feature}),Ext.Array.each(me._hydratedStories,function(story){var oid=story.get("ObjectID");me._hydratedArtifactsByOid[oid]=story}),Ext.Array.each(me._hydratedStoryTasks,function(task){var oid=task.get("ObjectID");me._hydratedArtifactsByOid[oid]=task}),Ext.Array.each(me._hydratedStoryDefects,function(defect){var oid=defect.get("ObjectID");me._hydratedArtifactsByOid[oid]=defect}),Ext.Array.each(me._hydratedStoryDefects,function(task){var oid=task.get("ObjectID");me._hydratedArtifactsByOid[oid]=task})},_hydrateAllArtifactTags:function(scope){var me=scope;me.setLoading("Loading Existing Tags of Artifacts.");var deferred=Ext.create("Deft.Deferred"),promises=[];return Ext.iterate(me._hydratedArtifactsByOid,function(key,value){promises.push(me._hydrateArtifactTags(key,me))}),Deft.Promise.all(promises).then({success:function(results){deferred.resolve([])}}),deferred},_hydrateArtifactTags:function(artifactOid,scope){var deferred=Ext.create("Deft.Deferred"),me=scope,artifact=me._hydratedArtifactsByOid[artifactOid],artifactCollection=artifact.getCollection("Tags",{fetch:["ObjectID","Name"]}),collectionCount=artifactCollection.getCount();return artifactCollection.load({callback:function(records,operation,success){me._artifactTagsByOid[artifactOid]=records,deferred.resolve(records)}}),deferred},_tagAllArtifacts:function(scope){var deferred=Ext.create("Deft.Deferred"),me=scope;me.setLoading("Tagging Artifact Hierarchy");var promises=[];return Ext.iterate(me._hydratedArtifactsByOid,function(key,value){promises.push(me._tagArtifact(key,value,me))}),Deft.Promise.all(promises).then({success:function(results){deferred.resolve(results)}}),deferred},_tagArtifact:function(artifactOid,artifact,scope){var deferred=Ext.create("Deft.Deferred"),me=scope,existingArtifactTags=me._artifactTagsByOid[artifactOid],newTagArray=[],tagNamesToApply=[];if(!me._nullOutTagsFlag){var existingTagNames=[],existingTagRefs=[];Ext.Array.each(existingArtifactTags,function(tag){existingTagNames.push(tag.get("Name")),existingTagRefs.push(tag.get("_ref"))});var selectedTagNames=me._selectedTagNames,tagsRefsToApply=existingTagRefs;tagNamesToApply=existingTagNames,Ext.Array.each(me._selectedTagNames,function(selectedTagName){if(-1===existingTagNames.indexOf(selectedTagName)){var selectedTag=me._selectedTagsByName[selectedTagName];tagsRefsToApply.push(selectedTag.get("_ref")),tagNamesToApply.push(selectedTag.get("Name"))}}),newTagArray=_.map(tagsRefsToApply,function(ref){return{_ref:ref}})}return artifact.set("Tags",newTagArray),artifact.save({callback:function(result,operation){deferred.resolve(result)}}),deferred},_finishedNotify:function(scope){var me=scope;me.setLoading(!1),me._finishedOperationNotify(),me._nullOutExistingData(),me._nullOutSelectionData()},_finishedOperationNotify:function(){var me=scope,artifactLabel=artifact.get("FormattedID"),newTagNames="Empty tags.";me._statusContent&&me._statusContent.destroy(),me._statusContent=Ext.create("Ext.container.Container",{itemId:"statuscontent",xtype:"container",html:"Finished!"}),me.down("#status").add(me._statusContent)},_noSelectionsNotify:function(scope){var me=this;me._noFeatureDialog&&me._noFeatureDialog.destroy(),me._noFeatureDialog=Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"No Feature Selected.",message:"Please Select a Feature for Tagging.",confirmLabel:"Ok",listeners:{confirm:function(){}}})}});

            Rally.launchApp('CustomApp', {
                name:"PortfolioItem-DeepTag",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
